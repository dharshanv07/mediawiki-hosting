---
  - hosts: mediawiki
    become: true
    remote_user: ec2-user
    vars:
      mysql_root_password: "Password1"
      mysql_wiki_password: "Password2"

    tasks:
    - name: Update yum package
      yum: name=* state=latest

    - name: Instaling apache
      yum:
        name: ["httpd","php","php-mysqlnd","php-gd","php-xml","mariadb-server","mariadb","php-mbstring","php-json","wget"]
        state: present

    - name: Ensure apache starts at reboot
      service: name=httpd state=started enabled=yes

    - name: Ensure mariadb starts at reboot
      service: name=mariadb state=started enabled=yes
    
    - name: install pip3
      yum: name=python3-pip state=present

    - name: Install mysql.
      pip:
        name: pymysql

    - name: mysql_root_password
      mysql_user:
        login_user: root
        login_password: "{{ mysql_root_password }}"
        user: root
        check_implicit_admin: true
        password: "{{ mysql_root_password }}"
        host: localhost

    - name: Creating database
      mysql_db: name=wiki_database state=present login_user=root login_password={{ mysql_root_password }}

    - name: Create db User
      mysql_user: name=wiki password={{ mysql_wiki_password }} priv=wiki_database.*:ALL host='localhost' state=present login_user=root login_password={{ mysql_root_password }}
    - name: Downloading  installer dependencies
      yum:
        name: ['wget']
        state: present
    - name: Download mediawiki_package
      get_url:
        url: "https://releases.wikimedia.org/mediawiki/1.34/mediawiki-1.34.1.tar.gz"
        dest: "/home/ec2-user"
        force: yes
    - name: Unpack mediawiki download
      unarchive:
        src: "/home/ec2-user/mediawiki-1.34.1.tar.gz"
        dest: "/home/ec2-user"
        remote_src: true

    - name: move contents to webserver location
      command: "cp -r /home/ec2-user/mediawiki-1.34.1 /var/www/mediawiki"

    - name: Change document root path
      lineinfile:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^DocumentRoot '
        insertafter: '^#DocumentRoot '
        line: DocumentRoot "/var/www"
    - name: change directory path
      lineinfile:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^<Directory "/var/www/html" '
        insertafter: '^#<Directory '
        line: <Directory "/var/www">
    - name: directory file setup
      lineinfile:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^DirectoryIndex index.html'
        insertafter: '^#DirectoryIndex '
        line: DirectoryIndex index.html index.html.var index.php
    - name: Recursively change ownership of a directory
      file:
        path: /var/www/mediawiki
        state: directory
        recurse: yes
        owner: apache
        group: apache
      become: true
    - name: restart httpd
      service: name=httpd state=restarted
